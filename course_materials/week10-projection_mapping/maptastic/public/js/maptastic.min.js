/*! maptastic 2015-02-07 */
!function(){function a(b,c,d,e){if(d===c.length-1)return e(b);var f,g=c[d],h=Array(g);for(f=g-1;f>=0;--f)h[f]=a(b[f],c,d+1,e);return h}function b(a){for(var b=[];"object"==typeof a;)b.push(a.length),a=a[0];return b}function c(a){var c,d;return"object"==typeof a?(c=a[0],"object"==typeof c?(d=c[0],"object"==typeof d?b(a):[a.length,c.length]):[a.length]):[]}function d(a){var b,c=a.length,d=Array(c);for(b=c-1;-1!==b;--b)d[b]=a[b];return d}function e(b){return"object"!=typeof b?b:a(b,c(b),0,d)}function f(a,b){b=b||!1;var c,d,f,g,i,j,k,l,m,n=a.length,o=n-1,p=new Array(n);for(b||(a=e(a)),f=0;n>f;++f){for(k=f,j=a[f],m=h(j[f]),d=f+1;n>d;++d)g=h(a[d][f]),g>m&&(m=g,k=d);for(p[f]=k,k!=f&&(a[f]=a[k],a[k]=j,j=a[f]),i=j[f],c=f+1;n>c;++c)a[c][f]/=i;for(c=f+1;n>c;++c){for(l=a[c],d=f+1;o>d;++d)l[d]-=l[f]*j[d],++d,l[d]-=l[f]*j[d];d===o&&(l[d]-=l[f]*j[d])}}return{LU:a,P:p}}function g(a,b){var c,d,f,g,h,i=a.LU,j=i.length,k=e(b),l=a.P;for(c=j-1;-1!==c;--c)k[c]=b[c];for(c=0;j>c;++c)for(f=l[c],l[c]!==c&&(h=k[c],k[c]=k[f],k[f]=h),g=i[c],d=0;c>d;++d)k[c]-=k[d]*g[d];for(c=j-1;c>=0;--c){for(g=i[c],d=c+1;j>d;++d)k[c]-=k[d]*g[d];k[c]/=g[c]}return k}var h=Math.abs;solve=function(a,b,c){return g(f(a,c),b)}}();var Maptastic=function(a){var b=function(a,b,c){return a&&a.hasOwnProperty(b)&&null!==a[b]?a[b]:c},c=b(a,"labels",!0),d=b(a,"crosshairs",!1),e=b(a,"screenbounds",!1),f=b(a,"autoSave",!0),g=b(a,"autoLoad",!0),h=b(a,"layers",[]),i=b(a,"onchange",function(){}),j="maptastic.layers",k=null,l=null,m=[],n=!1,o=!1,p=[],q=null,r=null,s=20,t=null,u=null,v=[],w=[],x=function(a,b,c,d){return Math.sqrt(Math.pow(c-a,2)+Math.pow(d-b,2))},y=function(a,b,c,d){var e=b[1]*d[0]-b[0]*d[1]+(d[1]-b[1])*a[0]+(b[0]-d[0])*a[1],f=b[0]*c[1]-b[1]*c[0]+(b[1]-c[1])*a[0]+(c[0]-b[0])*a[1];if(0>e!=0>f)return!1;var g=-c[1]*d[0]+b[1]*(d[0]-c[0])+b[0]*(c[1]-d[1])+c[0]*d[1];return 0>g&&(e=-e,f=-f,g=-g),e>0&&f>0&&g>e+f},z=function(a,b){var c=y(a,b.targetPoints[0],b.targetPoints[1],b.targetPoints[2]),d=y(a,b.targetPoints[3],b.targetPoints[0],b.targetPoints[2]);return c||d},A=function(){i()},B=function(){if(n){l.strokeStyle="red",l.lineWidth=2,l.clearRect(0,0,k.width,k.height);for(var a=0;a<m.length;a++){l.beginPath(),l.strokeStyle=m[a]===u?"red":m[a]===q?"red":"white",l.moveTo(m[a].targetPoints[0][0],m[a].targetPoints[0][1]);for(var b=0;b<m[a].targetPoints.length;b++)l.lineTo(m[a].targetPoints[b][0],m[a].targetPoints[b][1]);l.lineTo(m[a].targetPoints[3][0],m[a].targetPoints[3][1]),l.closePath(),l.stroke();for(var f=[0,0],b=0;b<m[a].targetPoints.length;b++)l.strokeStyle=m[a].targetPoints[b]===t?"red":m[a].targetPoints[b]===r?"red":"white",f[0]+=m[a].targetPoints[b][0],f[1]+=m[a].targetPoints[b][1],l.beginPath(),l.arc(m[a].targetPoints[b][0],m[a].targetPoints[b][1],s/2,0,2*Math.PI,!1),l.stroke();if(f[0]/=4,f[1]/=4,c){var g=m[a].element.id.toUpperCase();l.font="16px sans-serif",l.textAlign="center";var h=l.measureText(g),i=[h.width+8,32];l.fillStyle="white",l.fillRect(f[0]-i[0]/2,f[1]-i[1]+8,i[0],i[1]),l.fillStyle="black",l.fillText(g,f[0],f[1])}}if(d&&(l.strokeStyle="yellow",l.lineWidth=1,l.beginPath(),l.moveTo(v[0],0),l.lineTo(v[0],k.height),l.moveTo(0,v[1]),l.lineTo(k.width,v[1]),l.stroke()),e){l.fillStyle="black",l.lineWidth=4,l.fillRect(0,0,k.width,k.height),l.strokeStyle="#909090",l.beginPath();for(var j=k.width/10,o=k.height/10,a=0;10>a;a++)l.moveTo(a*j,0),l.lineTo(a*j,k.height),l.moveTo(0,a*o),l.lineTo(k.width,a*o);l.stroke(),l.strokeStyle="white",l.strokeRect(2,2,k.width-4,k.height-4);var p=Math.round(.6*o);l.font=p+"px mono,sans-serif",l.fillRect(2*j+2,3*o+2,k.width-4*j-4,k.height-6*o-4),l.fillStyle="white",l.fontSize=20,l.fillText(k.width+" x "+k.height,k.width/2,k.height/2+.75*p),l.fillText("display size",k.width/2,k.height/2-.75*p)}}},C=function(a,b,c){var d=a[b][0],e=a[b][1];a[b][0]=a[c][0],a[b][1]=a[c][1],a[c][0]=d,a[c][1]=e},D=function(){k=document.createElement("canvas"),k.style.display="none",k.style.position="fixed",k.style.top="0px",k.style.left="0px",k.style.zIndex="1000000",l=k.getContext("2d"),document.body.appendChild(k),window.addEventListener("resize",P),window.addEventListener("mousemove",G),window.addEventListener("mouseup",H),window.addEventListener("mousedown",I),window.addEventListener("keydown",F),P()},E=function(a,b){for(var c=Math.sin(b),d=Math.cos(b),e=[0,0],f=0;f<q.targetPoints.length;f++)e[0]+=q.targetPoints[f][0],e[1]+=q.targetPoints[f][1];e[0]/=4,e[1]/=4;for(var f=0;f<q.targetPoints.length;f++){var g=q.targetPoints[f][0]-e[0],h=q.targetPoints[f][1]-e[1];q.targetPoints[f][0]=g*d-h*c+e[0],q.targetPoints[f][1]=g*c-h*d+e[1]}},F=function(a){if(!n)return 32==a.keyCode&&a.shiftKey?void N(!0):void 0;var b=a.keyCode,c=a.shiftKey?10:1,g=!1,h=[0,0];switch(b){case 32:if(a.shiftKey)return void N(!1);break;case 37:h[0]-=c;break;case 38:h[1]-=c;break;case 39:h[0]+=c;break;case 40:h[1]+=c;break;case 67:d=!d,g=!0;break;case 83:o=!1,g=!0;break;case 66:e=!e,B();break;case 72:q&&(C(q.sourcePoints,0,1),C(q.sourcePoints,3,2),M(),B());break;case 86:q&&(C(q.sourcePoints,0,3),C(q.sourcePoints,1,2),M(),B());break;case 82:q&&(E(q,Math.PI/2),M(),B())}if(!e)if(r)r[0]+=h[0],r[1]+=h[1],g=!0;else if(q){for(var i=0;i<q.targetPoints.length;i++)q.targetPoints[i][0]+=h[0],q.targetPoints[i][1]+=h[1];g=!0}g&&(M(),B(),f&&K(),A())},G=function(a){if(n)if(a.preventDefault(),w[0]=a.clientX-v[0],w[1]=a.clientY-v[1],v[0]=a.clientX,v[1]=a.clientY,o){var b=a.shiftKey?.1:1;if(r)r[0]+=w[0]*b,r[1]+=w[1]*b;else if(q)for(var c=0;c<q.targetPoints.length;c++)q.targetPoints[c][0]+=w[0]*b,q.targetPoints[c][1]+=w[1]*b;M(),f&&K(),B(),A()}else{k.style.cursor="default";var e=a.clientX,g=a.clientY,h=null!=t,i=null!=u;t=null;for(var c=0;c<m.length;c++)for(var j=m[c],l=0;l<j.targetPoints.length;l++){var p=j.targetPoints[l];if(x(p[0],p[1],e,g)<s){k.style.cursor="pointer",t=p;break}}u=null;for(var c=0;c<m.length;c++)if(z(v,m[c])){u=m[c];break}(d||h!=(null!=t)||i!=(null!=u))&&B()}},H=function(a){n&&(a.preventDefault(),o=!1)},I=function(a){if(n&&!e){a.preventDefault(),t=null,u?(q=u,o=!0):q=null,r=null;for(var b=a.clientX,c=a.clientY,d=0;d<m.length;d++)for(var f=m[d],g=0;g<f.targetPoints.length;g++){var h=f.targetPoints[g];if(x(h[0],h[1],b,c)<s){q=f,r=h,o=!0,p[0]=a.clientX-h[0],p[1]=a.clientY-h[1];break}}return B(),!1}},J=function(a,b){var c;if("string"==typeof a){if(c=document.getElementById(a),!c)throw"Maptastic: No element found with id: "+a}else a instanceof HTMLElement&&(c=a);for(var d=!1,e=0;e<m.length;e++)m[e].element.id==c.id&&(m[e].targetPoints=O(layout[i].targetPoints),d=!0);var f=c.offsetLeft,g=c.offsetTop;c.style.position="fixed",c.style.display="block",c.style.top="0px",c.style.left="0px",c.style.padding="0px",c.style.margin="0px";var h={element:c,width:c.clientWidth,height:c.clientHeight,sourcePoints:[],targetPoints:[]};if(h.sourcePoints.push([0,0],[h.width,0],[h.width,h.height],[0,h.height]),b)h.targetPoints=O(b);else{h.targetPoints.push([0,0],[h.width,0],[h.width,h.height],[0,h.height]);for(var i=0;i<h.targetPoints.length;i++)h.targetPoints[i][0]+=f,h.targetPoints[i][1]+=g}m.push(h),M()},K=function(){localStorage.setItem(j,JSON.stringify(Q(m)))},L=function(){if(localStorage.getItem(j)){for(var a=JSON.parse(localStorage.getItem(j)),b=0;b<a.length;b++)for(var c=0;c<m.length;c++)m[c].element.id==a[b].id&&(m[c].targetPoints=O(a[b].targetPoints));M()}},M=function(){for(var a=(["","-webkit-","-moz-","-ms-","-o-"].reduce(function(a,b){return b+"transform"in document.body.style?b:a})+"transform"),b=0;b<m.length;b++){for(var c=[],d=[],e=0,f=m[b].sourcePoints.length;f>e;++e){var g=m[b].sourcePoints[e],h=m[b].targetPoints[e];c.push([g[0],g[1],1,0,0,0,-g[0]*h[0],-g[1]*h[0]]),d.push(h[0]),c.push([0,0,0,g[0],g[1],1,-g[0]*h[1],-g[1]*h[1]]),d.push(h[1])}var i=solve(c,d,!0),j=[i[0],i[3],0,i[6],i[1],i[4],0,i[7],0,0,1,0,i[2],i[5],0,1];m[b].element.style[a]="matrix3d("+j.join(",")+")",m[b].element.style[a+"-origin"]="0px 0px 0px"}},N=function(a){n=a,k.style.display=a?"block":"none",a?B():(r=null,q=null,o=!1,e=!1)},O=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].slice(0,2));return b},P=function(){viewWidth=window.innerWidth,viewHeight=window.innerHeight,k.width=window.innerWidth,k.height=window.innerHeight,B()},Q=function(){for(var a=[],b=0;b<m.length;b++)a.push({id:m[b].element.id,targetPoints:O(m[b].targetPoints)});return a},R=function(a){for(var b=0;b<a.length;b++){for(var c=!1,d=0;d<m.length;d++)m[d].element.id==a[b].id&&(console.log("Setting points."),m[d].targetPoints=O(a[b].targetPoints),c=!0);if(c)console.log("Maptastic: Element '"+a[b].id+"' is already mapped.");else{var e=document.getElementById(a[b].id);e?J(e,a[b].targetPoints):console.log("Maptastic: Can't find element: "+a[b].id)}}M(),B()};D();for(var S=0;S<h.length;S++)(h[S]instanceof HTMLElement||"string"==typeof h[S])&&J(h[S]);for(var S=0;S<arguments.length;S++)(arguments[S]instanceof HTMLElement||"string"==typeof arguments[S])&&J(arguments[S]);return g&&L(),{getLayout:function(){return Q()},setLayout:function(a){R(a)},setConfigEnabled:function(a){N(a)},addLayer:function(a,b){J(a,b)}}};